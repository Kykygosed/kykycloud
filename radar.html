<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Kyky Radar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Inter, sans-serif;
}

#map {
    height: 100%;
    width: 100%;
}

#sidebar {
    position: absolute;
    top: 0;
    left: 0;
    width: 300px;
    height: 100%;
    background: rgba(20,20,20,0.95);
    color: white;
    padding: 20px;
    box-sizing: border-box;
    z-index: 1000;
    overflow-y: auto;
}

#sidebar button {
    width: 100%;
    margin-top: 10px;
    padding: 8px;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    font-weight: 600;
    cursor: pointer;
}

.input-popup {
    width: 100%;
    margin-top: 6px;
    padding: 6px;
    border-radius: 6px;
    border: none;
}

/* ==== ATC STYLE ==== */

.atc-airport {
    background: #3f3f46;
    color: white;
    padding: 6px 10px;
    border-radius: 10px;
    font-weight: 800;
    text-align: center;
    min-width: 80px;
}

.atc-positions {
    display: flex;
    gap: 4px;
    margin-top: 4px;
    justify-content: center;
}

.atc-box {
    height: 26px;
    min-width: 26px;
    border-radius: 6px;
    font-weight: 800;
    font-size: 13px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
}

.del { background: #7c3aed; }
.gnd { background: #f59e0b; }
.twr { background: #ef4444; }
.dep { background: #bbf7d0; color: #14532d; }
.app { background: #0ea5e9; }
</style>
</head>

<body>

<div id="map"></div>

<div id="sidebar">
    <h2>Kyky Radar</h2>
    <div>Online pilots: <span id="onlineCount">0</span></div>

    <button id="adminBtn" style="display:none">Admin</button>

    <div id="adminControls" style="display:none">
        <button id="newAirportBtn">Nouvel aéroport</button>
        <div id="airportConfig"></div>
    </div>

    <div style="margin-top:20px;border-top:1px solid rgba(255,255,255,.2);padding-top:10px">
        <strong>Aéroport sélectionné</strong>
        <div id="selectedAirport">Aucun</div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471"
});

const db = firebase.database();
const auth = firebase.auth();

// ================= MAP =================
const map = L.map("map").setView([20, 0], 2);

L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    maxZoom: 20
}).addTo(map);

const airportLayer = L.layerGroup().addTo(map);

// ================= UI =================
const adminBtn = document.getElementById("adminBtn");
const adminControls = document.getElementById("adminControls");
const newAirportBtn = document.getElementById("newAirportBtn");
const airportConfig = document.getElementById("airportConfig");
const selectedAirportDiv = document.getElementById("selectedAirport");

// ================= ADMIN =================
let creatingAirport = false;
let tempAirport = {};

adminBtn.onclick = () => {
    adminControls.style.display =
        adminControls.style.display === "none" ? "block" : "none";
};

newAirportBtn.onclick = () => {
    alert("Cliquez sur la carte pour placer l'aéroport");
    creatingAirport = true;
};

map.on("click", e => {
    if (!creatingAirport) return;

    tempAirport = {
        lat: e.latlng.lat,
        long: e.latlng.lng,
        positions: {
            DEL:{connected:false},
            GND:{connected:false},
            TWR:{connected:false},
            DEP:{connected:false},
            APP:{connected:false}
        }
    };

    airportConfig.innerHTML = `
        <input id="icao" class="input-popup" placeholder="ICAO">
        <input id="atisFreq" class="input-popup" placeholder="Fréquence ATIS">
        <textarea id="atisText" class="input-popup" placeholder="ATIS"></textarea>
        <button id="confirm">Confirmer</button>
    `;

    document.getElementById("confirm").onclick = async () => {
        tempAirport.icao = document.getElementById("icao").value.toUpperCase();
        tempAirport.atisfreq = document.getElementById("atisFreq").value;
        tempAirport.atis = document.getElementById("atisText").value;

        if (tempAirport.icao.length !== 4) return alert("ICAO invalide");

        await db.ref("airports").push(tempAirport);
        airportConfig.innerHTML = "";
        creatingAirport = false;
    };
});

// ================= ICON =================
function airportIcon(a) {
    const cfg = {
        DEL:["del","D"],
        GND:["gnd","G"],
        TWR:["twr","T"],
        DEP:["dep","DEP"],
        APP:["app","A"]
    };

    let boxes = "";
    Object.entries(cfg).forEach(([k,[cls,label]])=>{
        if (a.positions?.[k]?.connected) {
            boxes += `<div class="atc-box ${cls}">${label}</div>`;
        }
    });

    return L.divIcon({
        className:"",
        iconSize:[120,60],
        html:`
        <div class="atc-airport">
            ${a.icao}
            <div class="atc-positions">${boxes}</div>
        </div>`
    });
}

// ================= DATA =================
db.ref("airports").on("value", snap => {
    airportLayer.clearLayers();

    snap.forEach(a => {
        const d = a.val();
        const m = L.marker([d.lat,d.long],{icon:airportIcon(d)}).addTo(airportLayer);
        m.on("click",()=>showDetails(d));
    });
});

function showDetails(a){
    let list="";
    Object.entries(a.positions||{}).forEach(([k,p])=>{
        if(p.connected) list+=`<div>${k}</div>`;
    });

    selectedAirportDiv.innerHTML=`
        <strong>${a.icao}</strong><br><br>
        <strong>ATIS</strong><br>
        ${a.atisfreq}<br>
        <em>${a.atis}</em><br><br>
        <strong>Positions</strong><br>
        ${list||"Aucune"}
    `;
}

// ================= AUTH =================
auth.onAuthStateChanged(user=>{
    if(!user)return;
    db.ref("users/"+user.uid+"/admin").get().then(s=>{
        if(s.val()) adminBtn.style.display="block";
    });
});

// ================= ONLINE =================
db.ref("onlinepilots").on("value", s => {
    document.getElementById("onlineCount").innerText = s.val() || 0;
});
</script>

</body>
</html>
