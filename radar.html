<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Kyky Radar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body, html { margin:0; padding:0; height:100%; font-family:Inter,sans-serif; }
#map { position:absolute; top:0; bottom:0; left:0; right:0; }
.sidebar {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(20,20,20,0.85);
    padding: 15px;
    border-radius: 12px;
    color: white;
    z-index: 1000;
    width: 200px;
}
.sidebar h2 { margin-bottom: 10px; font-size:1.2rem; }
.sidebar button { margin-top: 8px; width:100%; padding:8px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
.sidebar button.admin { background:#f59e0b; color:white; display:none; }
</style>
</head>
<body>

<div id="map"></div>
<div class="sidebar">
    <h2>Kyky Radar</h2>
    <div>Online pilots: <span id="onlineCount">0</span></div>
    <button class="admin" id="newAirportBtn">Nouvel aÃ©roport</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// =====================
// ðŸ”¥ Firebase init
// =====================
const firebaseConfig = {
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// =====================
// ðŸ—ºï¸ Leaflet map
// =====================
const map = L.map("map", {
    zoomControl: true
}).setView([20, 0], 2);

// Fond noir & gris
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    attribution: "&copy; OpenStreetMap & CartoDB"
}).addTo(map);

// =====================
// ðŸ§  Stockage local
// =====================
const airportLayers = {};
const atcLayers = {};

// =====================
// âœˆï¸ Dessin aÃ©roport
// =====================
function drawAirport(id, data) {
    if (typeof data.lat !== "number" || typeof data.long !== "number") return;

    const lat = data.lat;
    const lng = data.long; // ðŸ”´ conversion OBLIGATOIRE

    const circle = L.circle([lat, lng], {
        radius: 8000,
        color: "#3b82f6",
        fillColor: "#3b82f6",
        fillOpacity: 0.35
    }).addTo(map);

    airportLayers[id] = circle;

    if (data.positions) {
        Object.values(data.positions).forEach(pos => {
            if (pos.connected === true) {
                drawATC(lat, lng, pos);
            }
        });
    }
}

// =====================
// ðŸŽ® Dessin ATC
// =====================
function drawATC(lat, lng, pos) {
    let layer;

    const tooltip = `<b>${pos.name}</b><br>${pos.frequency}`;

    // DELIVERY
    if (pos.name.endsWith("_DEL")) {
        layer = L.marker([lat, lng], {
            icon: L.divIcon({
                className: "",
                html: `<div style="
                    width:20px;height:20px;
                    border:3px solid red;
                    transform: rotate(45deg);
                    opacity:0.5;
                "></div>`
            })
        });
    }

    // GROUND
    else if (pos.name.endsWith("_GND")) {
        layer = L.circle([lat, lng], {
            radius: 12000,
            color: "yellow",
            fillOpacity: 0
        });
    }

    // TOWER
    else if (pos.name.endsWith("_TWR")) {
        layer = L.rectangle([
            [lat - 0.08, lng - 0.08],
            [lat + 0.08, lng + 0.08]
        ], {
            color: "green",
            fillOpacity: 0
        });
    }

    // DEPARTURE
    else if (pos.name.endsWith("_DEP")) {
        layer = L.rectangle([
            [lat - 0.12, lng - 0.12],
            [lat + 0.12, lng + 0.12]
        ], {
            color: "white",
            fillOpacity: 0
        });
    }

    // APPROACH
    else if (pos.name.endsWith("_APP")) {
        layer = L.rectangle([
            [lat - 0.25, lng - 0.25],
            [lat + 0.25, lng + 0.25]
        ], {
            color: "#7dd3fc",
            fillOpacity: 0
        });
    }

    if (!layer) return;

    layer.bindTooltip(tooltip);
    layer.addTo(map);

    atcLayers[pos.name] = layer;
}

// =====================
// ðŸ” Temps rÃ©el aÃ©roports
// =====================
db.ref("airports").on("value", snap => {
    Object.values(airportLayers).forEach(l => map.removeLayer(l));
    Object.values(atcLayers).forEach(l => map.removeLayer(l));

    Object.keys(airportLayers).length = 0;
    Object.keys(atcLayers).length = 0;

    snap.forEach(child => {
        drawAirport(child.key, child.val());
    });
});

// =====================
// ðŸ‘‘ Admin uniquement
// =====================
auth.onAuthStateChanged(user => {
    if (!user) return;

    db.ref("users/" + user.uid + "/admin").get().then(snap => {
        if (snap.val() === true) {
            document.getElementById("adminBtn").style.display = "block";
        }
    });
});

// =====================
// ðŸ‘¥ Online pilots
// =====================
db.ref("onlinepilots").on("value", snap => {
    document.getElementById("onlineCount").innerText = snap.val() || 0;
});
</script>


</body>
</html>
