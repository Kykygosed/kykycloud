<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Kyky Radar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Inter, sans-serif;
}

#map {
    height: 100%;
    width: 100%;
}

#sidebar {
    position: absolute;
    top: 0;
    left: 0;
    width: 320px;
    height: 100%;
    background: rgba(20,20,20,0.95);
    color: white;
    padding: 20px;
    box-sizing: border-box;
    z-index: 1000;
    overflow-y: auto;
}

#sidebar button {
    width: 100%;
    margin-top: 10px;
    padding: 8px;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    font-weight: 600;
    cursor: pointer;
}

.input-popup {
    width: 100%;
    margin-top: 6px;
    padding: 6px;
    border-radius: 6px;
    border: none;
}

/* ==== ATC STYLE ==== */
.atc-airport {
    background: #3f3f46;
    color: white;
    padding: 6px 10px;
    border-radius: 10px;
    font-weight: 800;
    font-size: 14px;
    line-height: 1.2;
    text-align: center;
    min-width: 80px;
}

.atc-positions {
    display: flex;
    gap: 4px;
    margin-top: 4px;
    justify-content: center;
}

.atc-box {
    height: 22px;
    border-radius: 0px;
    font-weight: 700;
    font-size: 11px;
    line-height: 1;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    box-sizing: border-box;
}

.del { background: #7c3aed; }
.gnd { background: #f59e0b; }
.twr { background: #ef4444; }
.dep { background: #bbf7d0; color: #14532d; }
.app { background: #0ea5e9; }

.connected-cell { color: #0f0; font-weight: bold; }
.disconnected-cell { color: #f00; }

table { width: 100%; border-collapse: collapse; margin-top: 5px; }
table, th, td { border: 1px solid #555; }
th, td { padding: 4px; text-align: center; font-size: 12px; }
</style>
</head>

<body>

<div id="map"></div>

<div id="sidebar">
    <h2>Kyky Radar</h2>
    <div>Online pilots: <span id="onlineCount">0</span></div>

    <button id="adminBtn" style="display:none">Admin</button>

    <div id="adminControls" style="display:none; margin-top:10px;">
        <button id="newAirportBtn">Nouvel aéroport</button>
    </div>

    <div id="airportConfig"></div>

    <div style="margin-top:20px;border-top:1px solid rgba(255,255,255,.2);padding-top:10px">
        <strong>Aéroport sélectionné</strong>
        <div id="selectedAirport">Aucun</div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471"
});

const db = firebase.database();
const auth = firebase.auth();

// ================= MAP =================
const map = L.map("map").setView([20, 0], 2);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { maxZoom: 20 }).addTo(map);
const airportLayer = L.layerGroup().addTo(map);

// ================= UI =================
const adminBtn = document.getElementById("adminBtn");
const adminControls = document.getElementById("adminControls");
const newAirportBtn = document.getElementById("newAirportBtn");
const airportConfig = document.getElementById("airportConfig");
const selectedAirportDiv = document.getElementById("selectedAirport");

// ================= ADMIN =================
let creatingAirport = false;
let tempAirport = {};
let selectedAirportKey = null;

// Admin button
adminBtn.onclick = () => { adminControls.style.display = adminControls.style.display==="none"?"block":"none"; };

// ================= CREATE AIRPORT =================
newAirportBtn.onclick = () => { 
    alert("Cliquez sur la carte pour placer l'aéroport"); 
    creatingAirport = true; 
};

map.on("click", e => {
    if(!creatingAirport) return;

    tempAirport = { lat: e.latlng.lat, long: e.latlng.lng, positions:{} };
    airportConfig.innerHTML = `
        <input id="icao" class="input-popup" placeholder="ICAO">
        <input id="atisFreq" class="input-popup" placeholder="Fréquence ATIS">
        <textarea id="atisText" class="input-popup" placeholder="ATIS"></textarea>
        <button id="confirm">Confirmer</button>
    `;
    document.getElementById("confirm").onclick = async () => {
        tempAirport.icao = document.getElementById("icao").value.toUpperCase();
        tempAirport.atisfreq = document.getElementById("atisFreq").value;
        tempAirport.atis = document.getElementById("atisText").value;
        if(tempAirport.icao.length!==4) return alert("ICAO invalide");
        await db.ref("airports").push(tempAirport);
        airportConfig.innerHTML = ""; creatingAirport=false;
    };
});

// ================= TYPE POSITION =================
function detectType(name){
    name = (name||"").toLowerCase();
    if(name.endsWith("_del")) return ["del","D"];
    if(name.endsWith("_gnd")) return ["gnd","G"];
    if(name.endsWith("_twr")) return ["twr","T"];
    if(name.endsWith("_app")) return ["app","A"];
    if(name.endsWith("_dep")) return ["dep","DEP"];
    return ["del","D"];
}

// ================= ICON =================
function airportIcon(a){
    const zoom = map.getZoom();
    const positionsArray = Object.values(a.positions||{});
    let atLeastOneConnected = positionsArray.some(p=>p.connected);

    // Bas zoom = simple point
    if(zoom<6){
        const color = atLeastOneConnected ? "green" : "red";
        return L.divIcon({
            className:"",
            iconSize:[12,12],
            html:`<div style="width:12px;height:12px;background:${color};border-radius:50%;"></div>`
        });
    }

    // Zoom plus élevé = rectangle avec positions
    let scale = zoom<8 ? 0.5 : zoom<10 ? 0.8 : 1;
    let boxesHTML="", totalWidth=0;
    positionsArray.forEach(p=>{
        const [cls,label]=detectType(p.name);
        const boxWidth = Math.max(label.length*8+8,22);
        totalWidth += boxWidth + 4;
        boxesHTML += `<div class="atc-box ${cls}" style="width:${boxWidth}px">${label}</div>`;
    });
    totalWidth += 12; if(totalWidth<60) totalWidth=60;
    totalWidth *= scale;
    const height = 40*scale;

    return L.divIcon({
        className:"",
        iconSize:[totalWidth,height],
        html: `<div class="atc-airport" style="width:${totalWidth}px; transform: scale(${scale}); transform-origin: top center;">
                ${a.icao}
                <div class="atc-positions">${boxesHTML}</div>
               </div>`
    });
}

// ================= DATA =================
async function renderAirports(){
    const snap = await db.ref("airports").get();
    airportLayer.clearLayers();
    snap.forEach(a=>{
        const d = a.val();
        d.key = a.key;
        L.marker([d.lat,d.long],{icon:airportIcon(d)}).addTo(airportLayer)
         .on("click",()=>showDetails(d));
    });
}
db.ref("airports").on("value", renderAirports);
map.on("zoomend", renderAirports);

// ================= SHOW DETAILS & ADMIN SELECT =================
function showDetails(a){
    selectedAirportKey = a.key || null;

    let table = `<table>
        <tr><th>Position</th><th>Nom</th><th>Fréquence</th><th>Occupant</th><th>Connecté</th></tr>`;
    Object.values(a.positions||{}).forEach(p=>{
        const [cls,label]=detectType(p.name);
        const connectedClass = p.connected ? "connected-cell" : "disconnected-cell";
        table += `<tr>
            <td>${label}</td>
            <td>${p.name||"-"}</td>
            <td>${p.freq||"-"}</td>
            <td>${p.occupant||"-"}</td>
            <td class="${connectedClass}">${p.connected?"Oui":"Non"}</td>
        </tr>`;
    });
    table += `</table>`;
    selectedAirportDiv.innerHTML=`
        <strong>${a.icao}</strong><br><br>
        <strong>ATIS</strong><br>${a.atisfreq||"-"}<br><em>${a.atis||"-"}</em><br><br>
        <strong>Positions</strong><br>${table}
    `;
}

// ================= ADMIN CREATE POSITION BUTTON =================
const addPositionBtn = document.createElement("button");
addPositionBtn.innerText = "Ajouter une position";
adminControls.appendChild(addPositionBtn);
addPositionBtn.style.display = "none"; // invisible par défaut

// Fonction pour mettre à jour la sélection et afficher le bouton si admin
function selectAirport(a) {
    selectedAirportKey = a.key || null;
    addPositionBtn.style.display = (selectedAirportKey && adminBtn.style.display!=="none") ? "block" : "none";
    showDetails(a);
}

// Modifier la fonction showDetails pour utiliser selectAirport
function showDetails(a){
    selectAirport(a); // met à jour bouton + sélection

    let table = `<table>
        <tr><th>Position</th><th>Nom</th><th>Fréquence</th><th>Occupant</th><th>Connecté</th></tr>`;
    Object.values(a.positions||{}).forEach(p=>{
        const [cls,label]=detectType(p.name);
        const connectedClass = p.connected ? "connected-cell" : "disconnected-cell";
        table += `<tr>
            <td>${label}</td>
            <td>${p.name||"-"}</td>
            <td>${p.freq||"-"}</td>
            <td>${p.occupant||"-"}</td>
            <td class="${connectedClass}">${p.connected?"Oui":"Non"}</td>
        </tr>`;
    });
    table += `</table>`;
    selectedAirportDiv.innerHTML=`
        <strong>${a.icao}</strong><br><br>
        <strong>ATIS</strong><br>${a.atisfreq||"-"}<br><em>${a.atis||"-"}</em><br><br>
        <strong>Positions</strong><br>${table}
    `;
}

// ================= AFTER CREATING AIRPORT =================
document.getElementById("confirm").onclick = async () => {
    tempAirport.icao = document.getElementById("icao").value.toUpperCase();
    tempAirport.atisfreq = document.getElementById("atisFreq").value;
    tempAirport.atis = document.getElementById("atisText").value;
    if(tempAirport.icao.length!==4) return alert("ICAO invalide");

    const ref = await db.ref("airports").push(tempAirport);
    airportConfig.innerHTML = ""; 
    creatingAirport=false;

    // Sélectionner le nouvel aéroport automatiquement
    const snap = await ref.get();
    const newAirport = snap.val();
    newAirport.key = ref.key;
    showDetails(newAirport); // affiche détails + bouton Ajouter position
};


// ================= AUTH =================
auth.onAuthStateChanged(user=>{
    if(!user)return;
    db.ref("users/"+user.uid+"/admin").get().then(s=>{
        if(s.val()) { 
            adminBtn.style.display="block"; 
            addPositionBtn.style.display = selectedAirportKey ? "block":"none";
        }
    });
});

// ================= ONLINE =================
db.ref("onlinepilots").on("value", s=>{
    document.getElementById("onlineCount").innerText = s.val()||0;
});
</script>

</body>
</html>
