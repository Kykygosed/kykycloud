<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Kyky Radar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body, html { margin:0; padding:0; height:100%; font-family:Inter,sans-serif; }
#map { position:absolute; top:0; bottom:0; left:0; right:0; }
.sidebar {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(20,20,20,0.85);
    padding: 15px;
    border-radius: 12px;
    color: white;
    z-index: 1000;
    width: 200px;
}
.sidebar h2 { margin-bottom: 10px; font-size:1.2rem; }
.sidebar button { margin-top: 8px; width:100%; padding:8px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
.sidebar button.admin { background:#f59e0b; color:white; display:none; }
</style>
</head>
<body>

<div id="map"></div>
<div class="sidebar">
    <h2>Kyky Radar</h2>
    <div>Online pilots: <span id="onlineCount">0</span></div>
    <button class="admin" id="newAirportBtn">Nouvel aéroport</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// Leaflet map
const map = L.map('map').setView([20,0], 2);

// Tiles noir/gris
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
}).addTo(map);

const airportMarkers = L.layerGroup().addTo(map);

let currentUser;
auth.onAuthStateChanged(async user => {
    if (!user) return window.location.href="auth.html";
    currentUser = user;

    // Vérifie si admin pour bouton
    const snap = await db.ref("users/"+user.uid).get();
    const data = snap.val() || {};
    if (data.admin === true) document.getElementById("newAirportBtn").style.display="block";

    // Online pilots count
    db.ref("onlinepilots").on('value', s=>document.getElementById("onlineCount").innerText = s.val()||0);
});

// Gestion airports et positions
function updateAirports() {
    airportMarkers.clearLayers();

    db.ref("airports").get().then(snap => {
        snap.forEach(aSnap => {
            const airport = aSnap.val();
            const lat = airport.lat;
            const lng = airport.lng;

            // Rond bleu aéroport
            L.circle([lat,lng], { radius:200, color:'blue', fillColor:'blue', fillOpacity:0.3 }).addTo(airportMarkers);

            if (!airport.positions) return;
            Object.values(airport.positions).forEach(pos=>{
                if (!pos.connected) return;

                let shape;
                const tooltipText = `${pos.name} : ${pos.frequency || ''}`;

                if(pos.name.endsWith("_DEL")){
                    shape = L.marker([lat,lng],{
                        icon: L.divIcon({
                            className:'cross-delivery',
                            html:`<div style="width:20px;height:20px;border-left:2px solid red;border-top:2px solid red;transform:rotate(45deg);opacity:0.5"></div>`,
                            iconSize:[20,20]
                        })
                    });
                } else if(pos.name.endsWith("_GND")){
                    shape = L.circle([lat,lng],{ radius:250, color:'yellow', fillColor:'yellow', fillOpacity:0.4 });
                } else if(pos.name.endsWith("_TWR")){
                    shape = L.rectangle([[lat-0.0005,lng-0.0005],[lat+0.0005,lng+0.0005]], { color:'green', fillOpacity:0.4 });
                } else if(pos.name.endsWith("_DEP")){
                    shape = L.rectangle([[lat-0.001,lng-0.001],[lat+0.001,lng+0.001]], { color:'white', fillOpacity:0.4 });
                } else if(pos.name.endsWith("_APP")){
                    shape = L.rectangle([[lat-0.002,lng-0.002],[lat+0.002,lng+0.002]], { color:'deepskyblue', fillOpacity:0.3 });
                }

                if(shape){
                    shape.bindTooltip(tooltipText, { permanent:false, direction:'top' });
                    shape.addTo(airportMarkers);
                }
            });
        });
    });
}

updateAirports();
db.ref("airports").on('value', updateAirports);

// Admin: ajouter un nouvel aéroport
let creatingAirport = false;
document.getElementById("newAirportBtn").onclick = ()=>{
    alert("Cliquez sur la carte pour placer le nouvel aéroport.");
    creatingAirport = true;
};

map.on('click', async e=>{
    if(!creatingAirport) return;
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    const icao = prompt("Nom de l'aéroport (ICAO 4 lettres):").toUpperCase();
    if(!icao) return;

    const airportRef = db.ref("airports").push();
    await airportRef.set({ icao:icao, lat:lat, lng:lng, positions:{} });

    alert("Aéroport créé. Vous pouvez maintenant ajouter des positions ATC.");
    creatingAirport = false;
});
</script>

</body>
</html>
